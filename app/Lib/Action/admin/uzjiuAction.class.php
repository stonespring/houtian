<?php
//后天网络授权联系QQ597990793 旺旺lusunchenjun 论坛http://www.houtianbest.cn/

class uzjiuAction extends BackendAction {public function _initialize(){parent::_initialize();$this->_mod =D('uzjiu_cate');header('Content-Type:text/html; charset=utf-8');if(!$this->checkAuth()){echo '网站未被授权 请联系后天网络授权QQ597990793 旺旺lusunchenjun 论坛<a href="http:\/\/houtianbest.cn" target="_blank">houtianbest.cn</a>';exit();}}public function index(){$this->display();}public function setting(){if (IS_POST){$cate_id =$this->_post('cate_id', 'trim');$uzjiu_cate_id =$this->_post('uzjiu_cate_id', 'trim');$coupon_start_time =strtotime($_POST['coupon_start_time']);$coupon_end_time =strtotime($_POST['coupon_end_time']);$sex =$this->_post('sex', 'intval');if (!$uzjiu_cate_id){$this->ajaxReturn(0, '采集分类必须选择！');}if (!$cate_id){$this->ajaxReturn(0, '入库分类必须选择！');}$uzjiu_cate_id =iconv('UTF-8', 'GBK//IGNORE', $uzjiu_cate_id);$cid =urlencode(trim($uzjiu_cate_id));F('uzjp_setting', array('cate_id' => $cate_id, 'cat_id' => $cat_id, 'page' => $page, 'sex' => $sex, 'coupon_start_time' => $coupon_start_time, 'coupon_end_time' => $coupon_end_time, ));$this->collect();}}public function collect(){$source ='';if (false === ($setting =F('uzjp_setting'))){$this->ajaxReturn(0, L('illegal_parameters'));}$p =$this->_get('p', 'intval', 1);$url ='http://jiukuaiyoucom.uz.taobao.com/list.htm?tagName=' . $setting['cid'] . '&page=' . $p . '&pageSize=40';if ($p == 1){$totalcoll =0;$order_num =0;}else {$totalcoll =F('totalcoll');$order_num =F('order_num');}$coll =0;$htian_https =new htian_https();$htian_https->fetch($url);$source =$htian_https->results;if (!$source){$source =file_get_contents($url);}$source =rtrim(ltrim(trim($source), '('), ')');$source =iconv('gbk', 'UTF-8//IGNORE', $source);if (strpos($source, '<div class="c-no-result">')){$this->ajaxReturn(0, '该类目暂时没有特价商品');}if (preg_match_all('/<li class="J_SiteSItem"(.*?)li>/s', $source, $matchitem)){for ($i =0;$i < count($matchitem[1]);$i++){$item =$matchitem[1][$i];$title =get_word($item, '<a class="item-desc"', '\\/a>');$title =get_word($title, 'target="_blank">', '<');$img =get_word($item, '<img src="', '"');$img =str_replace('_200x200xz.jpg', '', $img);$iid =get_word($item, 'data-id="', '>');$iid =get_word($iid, '_', '"');$likes =rand(99, 9999);$itemUrl ='http://open.nedor.cn/api/?id=' . $iid;$ch =curl_init();curl_setopt($ch, CURLOPT_URL, $itemUrl);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);curl_setopt($ch, CURLOPT_MAXREDIRS, 2);$contents =curl_exec($ch);curl_close($ch);if (!$contents){$contents =file_get_contents($itemUrl);}$comslist =json_decode($contents, true);$info =array();$info['title'] =$comslist['title'];$info['coupon_price'] =$comslist['coupon_price'];$info['price'] =$comslist['price'];$info['volume'] =$comslist['volume'];$info['sellerId'] =$comslist['sellerId'];$info['nick'] =$comslist['nick'];$info['shop_type'] =$comslist['shop_type'];$info['commission'] =$comslist['commission'];$info['commission_rate'] =$comslist['commission_rate'];$ems =$comslist['data']['delivery']['deliveryFees'][0];if ($ems == '卖家包邮'){$ems =0;}else {$ems =0;}$zkou =round($zkprice / $price * 10, 1);$nick =$info['nick'];$commission_rate =$info['commission_rate'];$commission =$info['commission'];$shop_type =$info['shop_type'];$sellerId =$info['sellerId'];$volume =$info['volume'];$intro =$info['intro'];$zkprice =$info['coupon_price'];$price =$info['price'];$zkou =round($zkprice / $price * 10, 1);$tag_list =d('items')->get_tags_by_title($title);$tags =implode(' ', $tag_list);$itemarray['shop_type'] =$shop_type;$itemarray['commission_rate'] =$commission_rate;$itemarray['commission'] =$commission;$itemarray['title'] =$title;$itemarray['tags'] =$tags;$itemarray['pic_url'] =$img;$itemarray['num_iid'] =$iid;$itemarray['price'] =$price;$itemarray['coupon_price'] =$zkprice;$itemarray['volume'] =$volume;$itemarray['nick'] =$nick;$itemarray['sellerId'] =$sellerId;$itemarray['intro'] =$intro;$itemarray['ems'] =$ems;$itemarray['likes'] =$likes;$itemarray['cate_id'] =$setting['cate_id'];$itemarray['coupon_rate'] =$zkou * 1000;$itemarray['coupon_end_time'] =$setting['coupon_end_time'];$itemarray['coupon_start_time'] =$setting['coupon_start_time'];$itemarray['sex'] =$setting['sex'];if ($title && $img && $iid){$result['item_list'][] =$itemarray;}}}foreach ($result['item_list'] as $key => $val){$res =$this->_ajax_tb_publish_insert($val);if ($res > 0){$coll++;$order_num++;}$totalcoll++;};if (!strpos($source, '下一页')){$this->ajaxReturn(0, '已经采集完成' . $p . '页,本次采集到' . $order_num . '件商品！请返回，谢谢');}F('totalcoll', $totalcoll);F('order_num', $order_num);$this->assign('p', $p);$this->assign('coll', $coll);$this->assign('order_num', $order_num);$this->assign('totalcoll', $totalcoll);$resp =$this->fetch('collect');$this->ajaxReturn(1, '', $resp);}private function _ajax_tb_publish_insert($item){$item['title'] =trim(strip_tags($item['title']));$item['pic_url'] ='http:' . $item['pic_url'];$result =D('items')->ajax_yg_publish($item);return $result;}}